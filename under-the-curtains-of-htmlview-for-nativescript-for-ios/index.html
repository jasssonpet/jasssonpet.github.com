<!DOCTYPE HTML> <html> <head> <meta charset="utf-8"> <title>Under the Curtains of &lt;HTMLView /&gt; for NativeScript for iOS | Jason Zhekov&#39;s Blog</title> <meta name="author" content="Jason Zhekov"> <meta name="description" content="We just released version 1.2 of NativeScript which among many new features included a new &amp;lt;HTMLView /&amp;gt; element. I’ll show you what stands behind it with nothing but plain JavaScript running on the iOS runtime."> <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"> <meta property="og:title" content="Under the Curtains of &lt;HTMLView /&gt; for NativeScript for iOS"> <meta property="og:site_name" content="Jason Zhekov&#39;s Blog"> <meta property="og:image" content="undefined"> <link href="/favicon.png" rel="icon"> <link rel="alternate" href="/atom.xml" title="Jason Zhekov&#39;s Blog" type="application/atom+xml"> <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head></html> <body> <header id="header" class="inner"><div class="alignleft"> <h1><a href="/">Jason Zhekov&#39;s Blog</a></h1> <h2><a href="/"></a></h2> </div> <nav id="main-nav" class="alignright"> <ul> <li><a href="/">Home</a></li> <li><a href="/archives">Archives</a></li> <li><a href="/about-me">About</a></li> </ul> <div class="clearfix"></div> </nav> <div class="clearfix"></div></header> <div id="content" class="inner"> <div id="main-col"><div id="wrapper"><article class="post"> <div class="post-content"> <header> <div class="icon"></div> <time datetime="2015-08-02T21:00:00.000Z"><a href="/under-the-curtains-of-htmlview-for-nativescript-for-ios/">2015-08-03</a></time> <h1 class="title">Under the Curtains of &lt;HTMLView /&gt; for NativeScript for iOS</h1> </header> <div class="entry"> <p>We just released <a href="https://www.nativescript.org/blog/nativescript-1.2-release---live-sync-push-notifications-native-plugins-and-more">version 1.2 of NativeScript</a> which among many new features included a new <a href="https://docs.nativescript.org/ApiReference/ui/html-view/HOW-TO"><code>&lt;HTMLView /&gt;</code></a> element. I’ll show you what stands behind it with nothing but plain JavaScript running on the <a href="https://github.com/NativeScript/ios-runtime">iOS runtime</a>.</p> <a id="more"></a> <p>We are going to start with the iOS <a href="https://docs.nativescript.org/runtimes/ios/getting-started/HelloWorld">“Hello, World!” template</a> and we will replace the contents of the label from <code>NSString</code> with <code>NSAttributedString</code>. On iOS the <code>&lt;HTMLView /&gt;</code> element uses <code>NSAttributedString</code> to render itself. You can read more about it in the <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSAttributedString_Class/">Apple docs</a>, but in short “it manages character strings and associated sets of attributes (for example, font and kerning) that apply to individual characters or ranges of characters in the string”.</p> <p><a href="https://gist.github.com/jasssonpet/1637318e302096148885"><img src="/under-the-curtains-of-htmlview-for-nativescript-for-ios/html-view-demo.png" alt="Hello, NativeScript!" title="Hello, NativeScript!"></a></p> <blockquote> <p>You can see the whole code example in <a href="https://gist.github.com/jasssonpet/1637318e302096148885">this gist</a>.</p> </blockquote> <p>Here is how you create a <code>NSAttributedString</code> using Swift 2 (not released yet as of writing):<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">attributedStringFromHTMLString</span><span class="params">(str: NSString)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">NSAttributedString</span> &#123;</div><div class="line">    <span class="keyword">let</span> encodedData = str.dataUsingEncoding(<span class="type">NSUTF8StringEncoding</span>)!</div><div class="line">    <span class="keyword">let</span> attributeOptions: [<span class="type">String</span>: <span class="type">AnyObject</span>] = [</div><div class="line">        <span class="type">NSDocumentTypeDocumentAttribute</span>: <span class="type">NSHTMLTextDocumentType</span>,</div><div class="line">        <span class="type">NSCharacterEncodingDocumentAttribute</span>: <span class="type">NSUTF8StringEncoding</span></div><div class="line">    ]</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">try</span> <span class="type">NSAttributedString</span>(data: encodedData, options: attributeOptions, documentAttributes: <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p> <p>And here is how you do it with NativeScript 1.2:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">attributedStringFromHTMLString</span>(<span class="params">str</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> encodedData = NSString.stringWithString(str).dataUsingEncoding(NSUTF8StringEncoding)</div><div class="line">    <span class="keyword">var</span> attributeOptions = &#123;</div><div class="line">        [NSDocumentTypeDocumentAttribute]: NSHTMLTextDocumentType,</div><div class="line">        [NSCharacterEncodingDocumentAttribute]: NSUTF8StringEncoding</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> NSAttributedString.alloc().initWithDataOptionsDocumentAttributesError(encodedData, attributeOptions, <span class="literal">null</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p> <p>These snippets look quite similar, don’t you think? The JavaScript code may look very simple, but there is a bit more going on. Let’s see the details one by one:</p> <h2 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"></a>Error Handling</h2><p>We are calling <a href="https://developer.apple.com/library/prerelease/ios/documentation/UIKit/Reference/NSAttributedString_UIKit_Additions/index.html#//apple_ref/occ/instm/NSAttributedString/initWithData:options:documentAttributes:error:">the following method</a>:<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">instancetype</span>)initWithData:(<span class="built_in">NSData</span> *)data</div><div class="line">                     options:(<span class="built_in">NSDictionary</span> *)options</div><div class="line">          documentAttributes:(<span class="built_in">NSDictionary</span> **)dict</div><div class="line">                       error:(<span class="built_in">NSError</span> **)error;</div></pre></td></tr></table></figure></p> <p>In Objective-C, you pass a reference to a <code>NSError</code> variable and the method will set it to a <code>NSError</code> object if there has been some kind of problem.</p> <p>As you might have noticed, this method has 4 parameters, but we are calling it with 3 arguments. This is because in Swift 2 Apple introduced <a href="https://developer.apple.com/library/prerelease/ios/documentation/Swift/Conceptual/BuildingCocoaApps/AdoptingCocoaDesignPatterns.html#//apple_ref/doc/uid/TP40014216-CH7-ID10">tighter integration with Objective-C error handling</a>. In Swift 2 you can skip the last parameter and use the <code>try</code>/<code>catch</code> mechanism to check if an error occurred.</p> <p>With the 1.2 release of the iOS runtime we made the same thing possible (<a href="https://github.com/NativeScript/ios-runtime/issues/186">#186</a>, <a href="https://docs.nativescript.org/runtimes/ios/marshalling/Marshalling-Overview#nserror--marshalling">docs</a>) and you can enjoy this neat feature before even Swift 2 is released. If you skip the last argument, this method will now throw a JavaScript object which wrapps the <code>NSError</code> object if the out parameter is set. You can use the JavaScript <code>try</code>/<code>catch</code> construct to check if an error occurred. (If you override such methods, any thrown JavaScript error will be respectively wrapped in a <code>NSError</code> object.)</p> <h2 id="ES6-Computed-Property-Names"><a href="#ES6-Computed-Property-Names" class="headerlink" title="ES6 Computed Property Names"></a>ES6 Computed Property Names</h2><p>One of the major changes in the 1.2 release of the iOS runtime is that we updated our JavaScriptCore engine. Our last update was more than 10 months ago, but we now use CMake to build our runtime and the JavaScriptCore engine and this allowed us to seemlessly upgrade it two times in the last release. This means that you will be using the latest JavaScript features such as <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer#Computed_property_names">computed property names</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">arrow functions</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/template_strings">template strings</a> on <em>all</em> iOS versions as soon as they become available (we bundle the JavaScriptCore engine with each app).</p> <p>Lets take a look at this object:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> attributeOptions = &#123;</div><div class="line">    [NSDocumentTypeDocumentAttribute]: NSHTMLTextDocumentType,</div><div class="line">    [NSCharacterEncodingDocumentAttribute]: NSUTF8StringEncoding</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p> <p>Starting with ECMAScript 6, the object initializer syntax also supports computed property names. That allows you to put an expression in brackets <code>[]</code>, that will be computed as the property name. In this snippet <code>NSDocumentTypeDocumentAttribute</code> and <code>NSCharacterEncodingDocumentAttribute</code> are Objective-C <code>NSString</code> global variables exposed in the global JavaScript scope.</p> <h2 id="Marshalling-from-JSON-Object-to-NSDictionary"><a href="#Marshalling-from-JSON-Object-to-NSDictionary" class="headerlink" title="Marshalling from JSON Object to NSDictionary"></a>Marshalling from JSON Object to <code>NSDictionary</code></h2><p>Notice that the <code>initWithData:options:documentAttributes:error:</code> method accepts a <code>NSDictionary</code> object as second parameter, but we are passing a plain JavaScript object. This is possible because the iOS runtime implicitly wraps it in a <code>NSDictionary</code> object (<a href="https://github.com/NativeScript/ios-runtime/pull/64">#64</a>). It doesn’t create a copy of the object, so this operation should be pretty fast.</p> <p>This is only some of the magic that happens in 5 lines of code in the iOS runtime. If you have any suggestions you would like to see implemented, we will be glad to <a href="https://github.com/NativeScript/ios-runtime/issues/new">discuss them on GitHub</a>.</p> <p><strong>P.S.</strong> More of a joke, but the last feature that allows the Swift and JavaScript code to look so alike is <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Lexical_grammar#Automatic_semicolon_insertion">JavaScript ASI</a>.</p> </div> <footer> <div class="clearfix"></div> </footer> </div> </article></div></div> </div> <footer id="footer" class="inner"><div class="alignleft"> &copy; 2016 Jason Zhekov </div> <div class="clearfix"></div></footer> </body> 